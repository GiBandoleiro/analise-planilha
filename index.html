<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Favicon (Ícone da Aba) -->
    <link rel="icon" type="logoGrafico/png">
    <title>Dashboard de Análise de Campanhas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #334155; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; }
        .card-title { color: #94a3b8; font-weight: 500; }
        .card-value { color: #f1f5f9; font-size: 1.75rem; font-weight: 700; } /* Fonte ajustada */
        .chart-container { position: relative; flex-grow: 1; min-height: 350px; }
        #file-drop-zone { border: 2px dashed #334155; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        #file-drop-zone:hover, #file-drop-zone.dragover { background-color: #1e293b; border-color: #4f46e5; }
        .filter-select, .filter-input, .search-input { background-color: #334155; border: 1px solid #475569; color: #e2e8f0; border-radius: 0.375rem; padding: 0.5rem; width: 100%; }
        .chart-type-selector, .category-selector { background-color: #334155; border: 1px solid #475569; color: #cbd5e1; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #4f46e5; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sortable-header { cursor: pointer; }
        .sortable-header:hover { color: #f1f5f9; }
        .pagination-btn { background-color: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.375rem; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn.active { background-color: #4f46e5; }
        
        /* Export Specific Styles */
        .export-render .card-value { font-size: 1.5rem !important; overflow-wrap: break-word; }
        .export-render .card { page-break-inside: avoid; }
        .export-render * { -webkit-hyphens: auto; -ms-hyphens: auto; hyphens: auto; }

        /* Custom multiselect */
        .multiselect-container { max-height: 200px; overflow-y: auto; }
        .multiselect-container label { display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 0.25rem; }
        .multiselect-container label:hover { background-color: #334155; }
        .custom-checkbox { appearance: none; -webkit-appearance: none; height: 1.25rem; width: 1.25rem; background-color: #475569; border-radius: 0.25rem; cursor: pointer; display: inline-block; position: relative; flex-shrink: 0; }
        .custom-checkbox:checked { background-color: #4f46e5; }
        .custom-checkbox:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 sm:p-6 lg:p-8 pb-20">
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="text-center"><div class="spinner"></div><p class="mt-4 text-white">Gerando...</p></div>
    </div>
    <div class="container mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-3 rounded-lg"><i class="fas fa-chart-pie fa-2x text-white"></i></div>
                <div><h1 class="text-2xl font-bold text-white">Dashboard Analytics</h1><p class="text-slate-400">Seus dados de campanha, analisados.</p></div>
            </div>
            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <div id="export-buttons" class="flex items-center gap-4 hidden">
                    <button id="download-image-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors"><i class="fas fa-file-image mr-2"></i> Baixar Imagem</button>
                    <button id="download-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors"><i class="fas fa-file-pdf mr-2"></i> Baixar PDF</button>
                </div>
                <label for="file-upload" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors"><i class="fas fa-upload mr-2"></i> Carregar CSV</label>
                <input id="file-upload" type="file" class="hidden" accept=".csv">
            </div>
        </header>
        <div id="upload-section" class="mb-8">
            <div id="file-drop-zone"><i class="fas fa-file-csv fa-3x text-slate-500 mb-4"></i><p class="text-slate-400" id="drop-zone-text">Arraste e solte seu arquivo CSV aqui, ou clique para selecionar.</p><p id="file-name" class="text-indigo-400 mt-2"></p></div>
        </div>
        <div id="dashboard-content" class="hidden">
            <div id="printable-content">
                <div id="filters-section" class="card mb-8">
                    <h2 class="font-bold text-lg mb-4">Filtros Dinâmicos</h2>
                    <div id="dynamic-filters-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"></div>
                    <div id="date-filter-container" class="flex flex-col sm:flex-row gap-4 items-end pt-4 border-t border-slate-700">
                        <div class="w-full flex flex-col gap-1"><label>Período</label><div class="flex items-center gap-2 bg-slate-700/50 p-2 rounded-lg"><span class="text-slate-400">De:</span><input type="date" id="filter-start-date" class="filter-input bg-transparent border-0 p-0"><span class="text-slate-400">Até:</span><input type="date" id="filter-end-date" class="filter-input bg-transparent border-0 p-0"></div></div>
                        <button id="clear-filters-btn" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full sm:w-auto flex-shrink-0">Limpar</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-6 mb-8">
                    <div class="card"><p class="card-title">Total Investido</p><p id="total-investido" class="card-value">R$ 0</p></div>
                    <div class="card" id="card-leads"><p class="card-title">Total de Leads</p><p id="total-leads" class="card-value">0</p></div>
                    <div class="card"><p class="card-title">Impressões</p><p id="total-impressoes" class="card-value">0</p></div>
                    <div class="card"><p class="card-title">Cliques</p><p id="total-cliques" class="card-value">0</p></div>
                    <div class="card"><p class="card-title">CTR</p><p id="ctr" class="card-value">0%</p></div>
                    <div class="card" id="card-cpl"><p class="card-title">CPL</p><p id="cpl" class="card-value">R$ 0</p></div>
                    <div class="card hidden" id="card-cpc"><p class="card-title">CPC Médio</p><p id="cpc" class="card-value">R$ 0</p></div>
                    <div class="card hidden" id="card-cpm"><p class="card-title">CPM Médio</p><p id="cpm" class="card-value">R$ 0</p></div>
                </div>
                <div class="card mb-8"><h2 class="font-bold text-lg mb-2">Insights com IA</h2><div id="ai-insights-content" class="text-slate-300 whitespace-pre-wrap">Clique no botão para gerar uma análise.</div><div id="ai-loading" class="hidden my-4"><div class="spinner"></div></div><button id="generate-ai-insights" class="mt-4 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full sm:w-auto self-start"><i class="fas fa-wand-magic-sparkles mr-2"></i>Gerar Análise</button></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card" id="timeline-card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Evolução Temporal</h2><select id="timeline-chart-type" class="chart-type-selector"><option value="line">Linha</option><option value="bar">Barra</option></select></div><div class="chart-container"><canvas id="timeline-chart"></canvas></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Análise por Categoria 1</h2><div class="flex items-center gap-2"><select id="chart1-category" class="category-selector"></select><select id="chart1-type" class="chart-type-selector"><option value="bar">Barra</option><option value="pie">Pizza</option></select><button id="chart1-labels-toggle" class="p-2 bg-slate-700 rounded-md hover:bg-slate-600 transition-colors hidden" title="Mostrar/Ocultar Rótulos"><i class="fas fa-tags"></i></button></div></div><div class="chart-container"><canvas id="chart1"></canvas></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Análise por Categoria 2</h2><div class="flex items-center gap-2"><select id="chart2-category" class="category-selector"></select><select id="chart2-type" class="chart-type-selector"><option value="bar">Barra</option><option value="doughnut">Rosca</option></select><button id="chart2-labels-toggle" class="p-2 bg-slate-700 rounded-md hover:bg-slate-600 transition-colors hidden" title="Mostrar/Ocultar Rótulos"><i class="fas fa-tags"></i></button></div></div><div class="chart-container"><canvas id="chart2"></canvas></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Análise por Categoria 3</h2><div class="flex items-center gap-2"><select id="chart3-category" class="category-selector"></select><select id="chart3-type" class="chart-type-selector"><option value="bar">Barra</option><option value="line">Linha</option></select><button id="chart3-labels-toggle" class="p-2 bg-slate-700 rounded-md hover:bg-slate-600 transition-colors hidden" title="Mostrar/Ocultar Rótulos"><i class="fas fa-tags"></i></button></div></div><div class="chart-container"><canvas id="chart3"></canvas></div></div>
                </div>
                <div class="card"><div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><h2 class="font-bold text-lg">Ranking de Campanhas</h2><input type="search" id="campaign-search" placeholder="Pesquisar campanha..." class="search-input md:w-1/3"></div><div class="overflow-x-auto"><table class="w-full text-left"><thead id="campaign-ranking-head"></thead><tbody id="campaign-ranking-body"></tbody></table></div><div id="pagination-controls" class="mt-4 flex justify-center items-center gap-2"></div></div>
            </div>
        </div>
    </div>
    <div class="fixed bottom-0 left-0 right-0 z-50 w-full text-center py-4 bg-gray-800 shadow-lg text-white">          <p class="text-sm flex justify-center items-center gap-4">            Desenvolvido por Giovanni Fuentes Giannetti:             <!-- Instagram -->            <a href="https://instagram.com/giovanni.fg" target="_blank" class="text-pink-400 hover:text-pink-300 flex items-center gap-1"> <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5"> <path d="M12 2.2c3.2 0 3.6 0 4.9.1 1.2.1 1.9.3 2.3.5.6.2 1 .6 1.4 1.1.4.4.9 1 1.1 1.6.2.4.4 1.1.5 2.3.1 1.3.1 1.7.1 4.9s0 3.6-.1 4.9c-.1 1.2-.3 1.9-.5 2.3-.2.6-.6 1-1.1 1.4-.4.4-1 .9-1.6 1.1-.4.2-1.1.4-2.3.5-1.3.1-1.7.1-4.9.1s-3.6 0-4.9-.1c-1.2-.1-1.9-.3-2.3-.5-.6-.2-1-.6-1.4-1.1-.4-.4-.9-1-1.1-1.6-.2-.4-.4-1.1-.5-2.3C2.2 15.6 2.2 15.2 2.2 12s0-3.6.1-4.9c.1-1.2.3-1.9.5-2.3.2-.6.6-1 1.1-1.4.4-.4 1-.9 1.6-1.1.4-.2 1.1.4 2.3.5C8.4 2.2 8.8 2.2 12 2.2m0-2.2C8.7 0 8.3 0 7 .1 5.7.2 4.7.4 4 .7c-.9.4-1.7 1-2.4 1.7C.9 3.1.3 3.9 0 4.8c-.3.7-.5 1.7-.6 3C-.7 9 .7 9.3.7 12s0 3 .1 4.2c.1 1.3.3 2.3.6 3 .3.9.9 1.7 1.6 2.4.7.7 1.5 1.3 2.4 1.6.7.3 1.7.5 3 .6 1.2.1 1.6.1 4.9.1s3.6 0 4.9-.1c1.3-.1 2.3-.3 3-.6.9-.3 1.7-.9 2.4-1.6.7-.7 1.3-1.5 1.6-2.4.3-.7.5-1.7.6-3 .1-1.2.1-1.6.1-4.9s0-3.6-.1-4.9c-.1-1.3-.3-2.3-.6-3-.3-.9-.9-1.7-1.6-2.4C21.1 1.6 20.3 1 19.4.7c-.7-.3-1.7-.5-3-.6C15.6 0 15.2 0 12 0z"/> <path d="M12 5.8a6.2 6.2 0 1 0 0 12.4A6.2 6.2 0 0 0 12 5.8zm0 10.2a4 4 0 1 1 0-8.1 4 4 0 0 1 0 8.1zM18.4 4.6a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>            </svg> @giovanni.fg </a>            <!-- LinkedIn -->            <a href="https://linkedin.com/in/giovanni-fg" target="_blank" class="text-blue-400 hover:text-blue-300 flex items-center gap-1">              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">                <path d="M4.98 3.5C4.98 5 3.9 6 2.5 6S0 5 0 3.5 1.12 1 2.5 1s2.48 1 2.48 2.5zM.5 8h4V24h-4V8zM8.5 8h3.8v2.2h.1c.5-.9 1.8-1.9 3.7-1.9 3.9 0 4.6 2.5 4.6 5.7V24h-4v-7.8c0-1.9 0-4.4-2.7-4.4-2.7 0-3.1 2.1-3.1 4.2V24h-4V8z"/>              </svg>              giovanni-fg            </a>          </p>      </div>
<script>
    const { jsPDF } = window.jspdf;
    Chart.register(ChartDataLabels);
    Chart.defaults.plugins.datalabels.display = false;
    Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#334155'; Chart.defaults.plugins.legend.position = 'bottom'; Chart.defaults.maintainAspectRatio = false;
    
    let originalData = [], filteredData = [], charts = {}, categoricalColumns = [];
    const GEMINI_API_KEY = 'AIzaSyA0LecQ2UW0nZvLTlnp-Utp4NHxVeIfvX8';
    const chartColors = ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6'];
    const elements = {
        fileUpload: document.getElementById('file-upload'), dropZone: document.getElementById('file-drop-zone'),
        fileName: document.getElementById('file-name'), uploadSection: document.getElementById('upload-section'),
        dashboardContent: document.getElementById('dashboard-content'), clearFiltersBtn: document.getElementById('clear-filters-btn'),
        dynamicFiltersContainer: document.getElementById('dynamic-filters-container'),
        dropZoneText: document.getElementById('drop-zone-text'), downloadPdfBtn: document.getElementById('download-pdf-btn'),
        downloadImageBtn: document.getElementById('download-image-btn'), exportButtons: document.getElementById('export-buttons'),
        aiBtn: document.getElementById('generate-ai-insights'), aiContent: document.getElementById('ai-insights-content'),
        aiLoading: document.getElementById('ai-loading'), loadingOverlay: document.getElementById('loading-overlay'),
        campaignSearch: document.getElementById('campaign-search'), paginationControls: document.getElementById('pagination-controls')
    };
    let tableState = { currentPage: 1, rowsPerPage: 5, searchTerm: '', sortColumn: 'spend', sortDirection: 'desc' };
    let has = { date: false, leads: false, cpc: false, cpm: false, spend: false, clicks: false, impressions: false };
    let chartLabelsState = { chart1: false, chart2: false, chart3: false };

    const formatCurrency = (v) => `R$ ${v.toFixed(2).replace('.', ',')}`;
    const formatNumber = (v) => new Intl.NumberFormat('pt-BR').format(v);
    const parseValue = (v) => { if (typeof v !== 'string' || v === '') return 0; const c = v.replace('R$', '').trim().replace(/\./g, '').replace(',', '.'); return isNaN(parseFloat(c)) ? 0 : parseFloat(c); };
    const parseInteger = (v) => { if (typeof v === 'number') return v; if (typeof v !== 'string' || v === '') return 0; const c = v.replace(/[^\d]/g, ''); const n = parseInt(c, 10); return isNaN(n) ? 0 : n; };
    
    function findColumn(headers, possibleNames) {
        for (const name of possibleNames) {
            const found = headers.find(h => h.toLowerCase().trim().includes(name.toLowerCase().trim()));
            if (found) return found;
        }
        return null;
    }
    
    function parseDate(dateStr) {
        if (!dateStr) return null;
        if (dateStr.includes('/')) { const parts = dateStr.split('/'); if (parts.length === 3) { const day = parseInt(parts[0], 10), month = parseInt(parts[1], 10), year = parseInt(parts[2], 10); if (day <= 31 && month <= 12 && year > 1900) return new Date(Date.UTC(year, month - 1, day)); } }
        const d = new Date(dateStr);
        if (!isNaN(d.getTime())) return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
        return null;
    }

    elements.fileUpload.addEventListener('change', (e) => handleFile(e.target.files[0]));
    elements.dropZone.addEventListener('click', () => elements.fileUpload.click());
    elements.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); elements.dropZone.classList.add('dragover'); });
    elements.dropZone.addEventListener('dragleave', () => elements.dropZone.classList.remove('dragover'));
    elements.dropZone.addEventListener('drop', (e) => { e.preventDefault(); elements.dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });

    function handleFile(file) {
        if (!file || file.type !== 'text/csv') return console.error('Tipo de arquivo inválido.');
        elements.fileName.textContent = file.name; elements.dropZoneText.textContent = 'Processando...';
        Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => { processData(r.data, r.meta.fields); elements.uploadSection.classList.add('hidden'); elements.dashboardContent.classList.remove('hidden'); elements.exportButtons.classList.remove('hidden'); }, error: (err) => { console.error('Erro no PapaParse:', err); elements.dropZoneText.textContent = 'Erro ao ler o arquivo.'; }});
    }

    function processData(data, headers) {
        const colNames = {
            campaign: findColumn(headers, ['Campaign Name']),
            date: findColumn(headers, ['Date', 'Data', 'Dia']),
            spend: findColumn(headers, ['Spend', 'Valor gasto', 'Custo', 'Investimento', 'Amount spent', 'Cost', 'Gasto']),
            leads: findColumn(headers, ['Action Leads', 'Leads']),
            clicks: findColumn(headers, ['Clicks', 'Cliques']),
            impressions: findColumn(headers, ['Impressions', 'Impressões']),
            cpc: findColumn(headers, ['CPC']),
            cpm: findColumn(headers, ['CPM'])
        };
        has = { date: !!colNames.date, leads: !!colNames.leads, cpc: !!colNames.cpc, cpm: !!colNames.cpm, spend: !!colNames.spend, clicks: !!colNames.clicks, impressions: !!colNames.impressions };
        if (!has.spend) { console.warn('Aviso: Nenhuma coluna de custo/investimento foi encontrada.'); }

        const primaryColumns = Object.values(colNames).filter(Boolean);
        categoricalColumns = headers.filter(h => !primaryColumns.includes(h) && new Set(data.map(item => item[h])).size > 1 && new Set(data.map(item => item[h])).size < 50);
        
        originalData = data.map(row => {
            const entry = {
                campaignName: row[colNames.campaign] || 'N/A', date: has.date ? parseDate(row[colNames.date]) : null,
                spend: has.spend ? parseValue(row[colNames.spend]) : 0,
                leads: has.leads ? parseInteger(row[colNames.leads]) : 0,
                clicks: has.clicks ? parseInt(parseValue(row[colNames.clicks] || '0'), 10) : 0,
                impressions: has.impressions ? parseInteger(row[colNames.impressions]) : 0,
                cpc: has.cpc ? parseValue(row[colNames.cpc]) : 0,
                cpm: has.cpm ? parseValue(row[colNames.cpm]) : 0
            };
            categoricalColumns.forEach(col => entry[col] = row[col] || 'N/A');
            return entry;
        });
        
        if (has.date) {
            const dateFilteredData = originalData.filter(row => row.date instanceof Date && !isNaN(row.date.getTime()));
            if (dateFilteredData.length > 0) {
                const dates = dateFilteredData.map(d => d.date);
                const minDate = new Date(Math.min(...dates)), maxDate = new Date(Math.max(...dates));
                document.getElementById('filter-start-date').value = minDate.toISOString().split('T')[0];
                document.getElementById('filter-end-date').value = maxDate.toISOString().split('T')[0];
            }
        }
        populateDynamicUI(headers); addListeners(); applyFilters();
    }
    
    function populateDynamicUI(headers) {
        elements.dynamicFiltersContainer.innerHTML = '';
        const campaignCol = findColumn(headers, ['Campaign Name']);
        if(campaignCol) {
            const container = document.createElement('div'); container.className = 'flex flex-col gap-1 relative';
            const label = document.createElement('label'); label.textContent = 'Campanhas';
            const button = document.createElement('button'); button.id = 'campaign-multiselect-btn'; button.className = 'filter-select text-left'; button.textContent = 'Selecionar...';
            const dropdown = document.createElement('div'); dropdown.id = 'campaign-multiselect-dropdown'; dropdown.className = 'hidden absolute top-full left-0 w-full bg-slate-600 border border-slate-700 rounded-md mt-1 z-10 p-2 multiselect-container';
            const uniqueCampaigns = [...new Set(originalData.map(item => item.campaignName))].sort();
            uniqueCampaigns.forEach(campaign => { const item = document.createElement('label'); item.className = 'flex items-center'; item.innerHTML = `<input type="checkbox" class="campaign-checkbox custom-checkbox" value="${campaign}"><span class="ml-2">${campaign}</span>`; dropdown.appendChild(item); });
            container.appendChild(label); container.appendChild(button); container.appendChild(dropdown);
            elements.dynamicFiltersContainer.appendChild(container);
        }

        categoricalColumns.forEach(colName => {
            const container = document.createElement('div'); container.className = 'flex flex-col gap-1';
            const label = document.createElement('label'); label.textContent = colName;
            const select = document.createElement('select'); select.className = 'filter-select dynamic-filter'; select.dataset.column = colName;
            select.innerHTML = `<option value="">Todos</option>`;
            const uniqueValues = [...new Set(originalData.map(item => item[colName]))].sort();
            uniqueValues.forEach(v => v && select.add(new Option(v, v)));
            container.appendChild(label); container.appendChild(select);
            elements.dynamicFiltersContainer.appendChild(container);
        });

        document.querySelectorAll('.category-selector').forEach((sel, i) => { sel.innerHTML = ''; categoricalColumns.forEach((col, j) => sel.add(new Option(col, col))); if (categoricalColumns[i]) sel.value = categoricalColumns[i]; });

        document.getElementById('card-leads').style.display = has.leads ? 'flex' : 'none';
        document.getElementById('card-cpl').style.display = has.leads && has.spend ? 'flex' : 'none';
        document.getElementById('card-cpc').style.display = has.cpc || (has.spend && has.clicks) ? 'flex' : 'none';
        document.getElementById('card-cpm').style.display = has.cpm || (has.spend && has.impressions) ? 'flex' : 'none';
        document.getElementById('date-filter-container').style.display = has.date ? 'flex' : 'none';
        document.getElementById('timeline-card').style.display = has.date ? 'flex' : 'none';
    }

    function addListeners() {
        document.getElementById('dynamic-filters-container').addEventListener('change', applyFilters);
        document.getElementById('filter-start-date').addEventListener('change', applyFilters);
        document.getElementById('filter-end-date').addEventListener('change', applyFilters);
        elements.clearFiltersBtn.addEventListener('click', () => { 
            document.querySelectorAll('.dynamic-filter, #filter-start-date, #filter-end-date').forEach(el => { if(el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; }); 
            const campaignCheckboxes = document.querySelectorAll('.campaign-checkbox');
            if (campaignCheckboxes.length > 0) {
                campaignCheckboxes.forEach(cb => cb.checked = false);
                document.getElementById('campaign-multiselect-btn').textContent = 'Selecionar...';
            }
            applyFilters(); 
        });
        document.querySelectorAll('.category-selector, .chart-type-selector').forEach(sel => sel.addEventListener('change', applyFilters));
        elements.downloadPdfBtn.addEventListener('click', downloadPDF);
        elements.downloadImageBtn.addEventListener('click', downloadImage);
        elements.aiBtn.addEventListener('click', generateInsights);
        elements.campaignSearch.addEventListener('input', (e) => { tableState.searchTerm = e.target.value; tableState.currentPage = 1; updateTables(); });
        
        const campaignBtn = document.getElementById('campaign-multiselect-btn');
        const campaignDropdown = document.getElementById('campaign-multiselect-dropdown');
        if (campaignBtn) {
            campaignBtn.addEventListener('click', () => campaignDropdown.classList.toggle('hidden'));
            document.addEventListener('click', (e) => { if (!campaignBtn.contains(e.target) && !campaignDropdown.contains(e.target) && !e.target.closest('#campaign-multiselect-dropdown')) campaignDropdown.classList.add('hidden'); });
            campaignDropdown.addEventListener('change', () => {
                const selectedCount = document.querySelectorAll('.campaign-checkbox:checked').length;
                campaignBtn.textContent = selectedCount > 0 ? `${selectedCount} selecionada(s)` : 'Selecionar...';
            });
        }
        [1, 2, 3].forEach(i => {
            document.getElementById(`chart${i}-labels-toggle`).addEventListener('click', () => {
                chartLabelsState[`chart${i}`] = !chartLabelsState[`chart${i}`];
                applyFilters();
            });
        });
    }

    function applyFilters() {
        const dynamicFilters = Array.from(document.querySelectorAll('.dynamic-filter')).map(sel => ({ key: sel.dataset.column, value: sel.value }));
        const selectedCampaigns = Array.from(document.querySelectorAll('.campaign-checkbox:checked')).map(cb => cb.value);
        const f = { start: document.getElementById('filter-start-date').valueAsDate, end: document.getElementById('filter-end-date').valueAsDate };
        if (f.start) f.start.setUTCHours(0, 0, 0, 0);
        if (f.end) f.end.setUTCHours(23, 59, 59, 999);
        filteredData = originalData.filter(row => {
            const dateMatch = !has.date || ((!f.start || row.date >= f.start) && (!f.end || row.date <= f.end));
            const categoryMatch = dynamicFilters.every(filter => !filter.value || row[filter.key] === filter.value);
            const campaignMatch = selectedCampaigns.length === 0 || selectedCampaigns.includes(row.campaignName);
            return dateMatch && categoryMatch && campaignMatch;
        });
        updateDashboard();
    }
    
    function updateDashboard() { updateCards(); updateAllCharts(); updateTables(); }

    function updateCards() {
        const totalSpend = filteredData.reduce((s, r) => s + r.spend, 0), totalLeads = filteredData.reduce((s, r) => s + r.leads, 0),
        totalImpressions = filteredData.reduce((s, r) => s + r.impressions, 0), totalClicks = filteredData.reduce((s, r) => s + r.clicks, 0);
        const ctr = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0, cpl = totalLeads > 0 ? totalSpend / totalLeads : 0;
        document.getElementById('total-investido').textContent = formatCurrency(totalSpend); document.getElementById('total-leads').textContent = formatNumber(totalLeads);
        document.getElementById('total-impressoes').textContent = formatNumber(totalImpressions); document.getElementById('total-cliques').textContent = formatNumber(totalClicks);
        document.getElementById('ctr').textContent = `${ctr.toFixed(2)}%`; document.getElementById('cpl').textContent = formatCurrency(cpl);

        if(has.cpc) { document.getElementById('cpc').textContent = formatCurrency(filteredData.reduce((s, r) => s + r.cpc, 0) / filteredData.length || 0); } 
        else if (has.spend && has.clicks) { document.getElementById('cpc').textContent = formatCurrency(totalClicks > 0 ? totalSpend / totalClicks : 0); }
        
        if(has.cpm) { document.getElementById('cpm').textContent = formatCurrency(filteredData.reduce((s, r) => s + r.cpm, 0) / filteredData.length || 0); }
        else if (has.spend && has.impressions) { document.getElementById('cpm').textContent = formatCurrency(totalImpressions > 0 ? (totalSpend / totalImpressions) * 1000 : 0); }
    }

    function updateTables() {
        const head = document.getElementById('campaign-ranking-head');
        head.innerHTML = `<tr class="border-b border-slate-700"><th class="p-2 sortable-header" data-sort="name">Campanha <i class="fas fa-sort"></i></th><th class="p-2 sortable-header" data-sort="spend">Gasto <i class="fas fa-sort"></i></th>` + (has.leads ? `<th class="p-2 sortable-header" data-sort="leads">Leads <i class="fas fa-sort"></i></th><th class="p-2 sortable-header" data-sort="cpl">CPL <i class="fas fa-sort"></i></th>` : '') + `</tr>`;
        const campaignData = filteredData.reduce((acc, row) => { acc[row.campaignName] = acc[row.campaignName] || { spend: 0, leads: 0 }; acc[row.campaignName].spend += row.spend; if(has.leads) acc[row.campaignName].leads += row.leads; return acc; }, {});
        let processedData = Object.entries(campaignData).map(([name, d]) => ({ name, ...d, cpl: d.leads > 0 ? d.spend / d.leads : 0 }));
        if (tableState.searchTerm) { processedData = processedData.filter(c => c.name.toLowerCase().includes(tableState.searchTerm.toLowerCase())); }
        processedData.sort((a, b) => { const valA = a[tableState.sortColumn], valB = b[tableState.sortColumn]; const compare = typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB; return tableState.sortDirection === 'asc' ? compare : -compare; });
        const body = document.getElementById('campaign-ranking-body'); body.innerHTML = '';
        const startIndex = (tableState.currentPage - 1) * tableState.rowsPerPage;
        const paginatedData = processedData.slice(startIndex, startIndex + tableState.rowsPerPage);
        paginatedData.forEach(c => { const row = body.insertRow(); row.className = 'border-b border-slate-800 hover:bg-slate-700/50'; row.innerHTML = `<td class="p-2 font-medium">${c.name}</td><td class="p-2">${formatCurrency(c.spend)}</td>` + (has.leads ? `<td class="p-2">${formatNumber(c.leads)}</td><td class="p-2">${formatCurrency(c.cpl)}</td>` : ''); });
        renderPagination(processedData.length);
    }
    
    function renderPagination(totalRows) {
        const pageCount = Math.ceil(totalRows / tableState.rowsPerPage);
        elements.paginationControls.innerHTML = '';
        for (let i = 1; i <= pageCount; i++) { const btn = document.createElement('button'); btn.textContent = i; btn.className = 'pagination-btn'; if (i === tableState.currentPage) btn.classList.add('active'); btn.addEventListener('click', () => { tableState.currentPage = i; updateTables(); }); elements.paginationControls.appendChild(btn); }
    }

    function drawOrUpdateChart(id, type, data, options = {}) { if (charts[id]) charts[id].destroy(); charts[id] = new Chart(document.getElementById(id), { type, data, options }); }

    function updateAllCharts() {
        if (has.date) {
            const timeData = filteredData.reduce((acc, item) => { 
                const key = item.date.toISOString().split('T')[0];
                if (!acc[key]) acc[key] = { spend: 0, leads: 0 }; 
                acc[key].spend += item.spend; 
                if (has.leads) acc[key].leads += item.leads; 
                return acc; 
            }, {});
            const sortedKeys = Object.keys(timeData).sort();
            const timeDatasets = [{ label: 'Investimento', data: sortedKeys.map(k => timeData[k].spend), backgroundColor: chartColors[0], yAxisID: 'y' }];
            if (has.leads) timeDatasets.push({ label: 'Leads', data: sortedKeys.map(k => timeData[k].leads), backgroundColor: chartColors[1], yAxisID: 'y1' });
            drawOrUpdateChart('timeline-chart', document.getElementById('timeline-chart-type').value, { labels: sortedKeys, datasets: timeDatasets}, { scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd/MM/yy' } }, y: { position: 'left' }, y1: { position: 'right', grid: { drawOnChartArea: false }, display: has.leads } } });
        }
        
        [1, 2, 3].forEach(i => {
            const category = document.getElementById(`chart${i}-category`).value;
            const type = document.getElementById(`chart${i}-type`).value;
            const toggleBtn = document.getElementById(`chart${i}-labels-toggle`);
            
            toggleBtn.style.display = (type === 'pie' || type === 'doughnut') ? 'block' : 'none';

            if (!category) return;
            const groupedData = filteredData.reduce((acc, item) => { const group = item[category] || 'N/A'; if (!acc[group]) acc[group] = { spend: 0, leads: 0 }; acc[group].spend += item.spend; if(has.leads) acc[group].leads += item.leads; return acc; }, {});
            const labels = Object.keys(groupedData);
            const chartDatasets = [{ label: 'Investimento', data: labels.map(l => groupedData[l].spend), backgroundColor: chartColors }];
            if (has.leads) chartDatasets.push({ label: 'Leads', data: labels.map(l => groupedData[l].leads), backgroundColor: chartColors.map(c => c + '99') });
            
            const options = {
                plugins: {
                    datalabels: {
                        display: chartLabelsState[`chart${i}`],
                        formatter: (value) => formatCurrency(value),
                        color: '#fff',
                        anchor: 'end',
                        align: 'start',
                        offset: -10,
                        borderRadius: 4,
                        backgroundColor: (context) => context.dataset.backgroundColor + 'AA',
                        padding: 4
                    }
                }
            };
            drawOrUpdateChart(`chart${i}`, type, { labels, datasets: chartDatasets}, options);
        });
    }

    async function generateCanvas() {
        const content = document.getElementById('printable-content');
        content.classList.add('export-render');
        await new Promise(resolve => setTimeout(resolve, 50));
        const canvas = await html2canvas(content, { 
            backgroundColor: '#0f172a', 
            scale: 1.5,
            useCORS: true,
            allowTaint: true
        });
        content.classList.remove('export-render');
        return canvas;
    }

    async function downloadImage() {
        elements.loadingOverlay.querySelector('p').textContent = 'Gerando Imagem...'; elements.loadingOverlay.classList.remove('hidden');
        const canvas = await generateCanvas(); const link = document.createElement('a'); link.download = 'dashboard-analytics.png'; link.href = canvas.toDataURL('image/png'); link.click(); elements.loadingOverlay.classList.add('hidden');
    }

    async function downloadPDF() {
        elements.loadingOverlay.querySelector('p').textContent = 'Gerando PDF...'; elements.loadingOverlay.classList.remove('hidden');
        const canvas = await generateCanvas(); const imgData = canvas.toDataURL('image/jpeg', 0.9); 
        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight(); const imgProps = pdf.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width; let heightLeft = imgHeight, position = 0;
        pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight, undefined, 'FAST'); heightLeft -= pdfHeight;
        while (heightLeft > 0) { position -= pdfHeight; pdf.addPage(); pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight, undefined, 'FAST'); heightLeft -= pdfHeight; }
        pdf.save('dashboard-analytics.pdf'); elements.loadingOverlay.classList.add('hidden');
    }

    async function generateInsights() {
        elements.aiBtn.disabled = true; elements.aiContent.classList.add('hidden'); elements.aiLoading.classList.remove('hidden');
        if (filteredData.length === 0) { elements.aiContent.textContent = 'Não há dados para gerar uma análise.'; elements.aiBtn.disabled = false; elements.aiContent.classList.remove('hidden'); elements.aiLoading.classList.add('hidden'); return; }
        const totalSpend = filteredData.reduce((s, r) => s + r.spend, 0);
        let insightsData = `- Investimento Total: ${formatCurrency(totalSpend)}`;
        if (has.leads) {
            const totalLeads = filteredData.reduce((s, r) => s + r.leads, 0);
            insightsData += ` - Total de Leads: ${formatNumber(totalLeads)} - CPL Médio: ${formatCurrency(totalLeads > 0 ? totalSpend / totalLeads : 0)}`;
        }
        const campaignSpend = filteredData.reduce((acc, row) => { if (row.campaignName !== 'N/A') { acc[row.campaignName] = (acc[row.campaignName] || 0) + row.spend; } return acc; }, {});
        const topCampaign = Object.keys(campaignSpend).length > 0 ? Object.entries(campaignSpend).sort(([, a], [, b]) => b - a)[0] : null;
        insightsData += ` - Campanha com maior investimento: ${topCampaign ? topCampaign[0] : 'N/A'} (${formatCurrency(topCampaign ? topCampaign[1] : 0)}) - Período: ${document.getElementById('filter-start-date').value || 'Início'} a ${document.getElementById('filter-end-date').value || 'Fim'}.`;
        
        const prompt = `Aja como um analista de marketing. Analise os dados a seguir e forneça insights em português. Dados: ${insightsData} Forneça uma análise concisa em 3 parágrafos: 1. Resumo da performance. 2. Ponto positivo e ponto de atenção. 3. Recomendação para otimização.`;
        const maxRetries = 3;
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (response.status === 503 && attempt < maxRetries - 1) { await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 1000)); continue; }
                if (!response.ok) { const errorBody = await response.text(); throw new Error(`API Error ${response.status}: ${errorBody}`); }
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error('Resposta da API inválida.');
                elements.aiContent.textContent = text;
                break;
            } catch (error) { 
                console.error(`Gemini API Error (Attempt ${attempt + 1}):`, error);
                if (attempt === maxRetries - 1) { elements.aiContent.textContent = 'Não foi possível gerar a análise. O serviço pode estar sobrecarregado. Tente novamente mais tarde.'; }
            }
        }
        elements.aiBtn.disabled = false; elements.aiContent.classList.remove('hidden'); elements.aiLoading.classList.add('hidden');
    }
</script>
</body>
</html>

