<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Campanhas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #334155; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; }
        .card-title { color: #94a3b8; font-weight: 500; }
        .card-value { color: #f1f5f9; font-size: 1.875rem; font-weight: 700; }
        .chart-container { position: relative; flex-grow: 1; min-height: 350px; }
        #file-drop-zone { border: 2px dashed #334155; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        #file-drop-zone:hover, #file-drop-zone.dragover { background-color: #1e293b; border-color: #4f46e5; }
        .filter-select, .filter-input, .search-input { background-color: #334155; border: 1px solid #475569; color: #e2e8f0; border-radius: 0.375rem; padding: 0.5rem; width: 100%; }
        .chart-type-selector { background-color: #334155; border: 1px solid #475569; color: #cbd5e1; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #4f46e5; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sortable-header { cursor: pointer; }
        .sortable-header:hover { color: #f1f5f9; }
        .pagination-btn { background-color: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.375rem; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn.active { background-color: #4f46e5; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex-col items-center justify-center hidden"><div class="spinner"></div><p class="mt-4 text-white">Gerando PDF...</p></div>
    <div class="container mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-3 rounded-lg"><i class="fas fa-chart-pie fa-2x text-white"></i></div>
                <div><h1 class="text-2xl font-bold text-white">Dashboard Analytics</h1><p class="text-slate-400">Seus dados de campanha, analisados.</p></div>
            </div>
            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <button id="download-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors hidden"><i class="fas fa-file-pdf mr-2"></i> Baixar PDF</button>
                <label for="file-upload" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors"><i class="fas fa-upload mr-2"></i> Carregar CSV</label>
                <input id="file-upload" type="file" class="hidden" accept=".csv">
            </div>
        </header>
        <div id="upload-section" class="mb-8">
            <div id="file-drop-zone"><i class="fas fa-file-csv fa-3x text-slate-500 mb-4"></i><p class="text-slate-400" id="drop-zone-text">Arraste e solte seu arquivo CSV aqui, ou clique para selecionar.</p><p id="file-name" class="text-indigo-400 mt-2"></p></div>
        </div>
        <div id="dashboard-content" class="hidden">
            <div id="filters-section" class="card mb-8">
                <h2 class="font-bold text-lg mb-4">Filtros</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="flex flex-col gap-1"><label>Cidade</label><select id="filter-cidade" class="filter-select"><option value="">Todas</option></select></div>
                    <div class="flex flex-col gap-1"><label>Tipo</label><select id="filter-tipo" class="filter-select"><option value="">Todos</option></select></div>
                    <div class="flex flex-col gap-1"><label>Status</label><select id="filter-status" class="filter-select"><option value="">Todos</option></select></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="w-full flex flex-col gap-1"><label>Período</label><div class="flex items-center gap-2 bg-slate-700/50 p-2 rounded-lg"><span class="text-slate-400">De:</span><input type="date" id="filter-start-date" class="filter-input bg-transparent border-0 p-0"><span class="text-slate-400">Até:</span><input type="date" id="filter-end-date" class="filter-input bg-transparent border-0 p-0"></div></div>
                    <button id="clear-filters-btn" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full sm:w-auto flex-shrink-0">Limpar</button>
                </div>
            </div>
            <div id="printable-content">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
                    <div class="card"><p class="card-title">Total Investido</p><p id="total-investido" class="card-value">R$ 0</p></div>
                    <div class="card"><p class="card-title">Total de Leads</p><p id="total-leads" class="card-value">0</p></div>
                    <div class="card"><p class="card-title">Impressões</p><p id="total-impressoes" class="card-value">0</p></div>
                    <div class="card"><p class="card-title">Cliques</p><p id="total-cliques" class="card-value">0</p></div>
                    <div class="card"><p class="card-title">CTR</p><p id="ctr" class="card-value">0%</p></div>
                    <div class="card"><p class="card-title">CPL</p><p id="cpl" class="card-value">R$ 0</p></div>
                </div>
                <div class="card mb-8"><h2 class="font-bold text-lg mb-2">Insights com IA</h2><div id="ai-insights-content" class="text-slate-300 whitespace-pre-wrap">Clique no botão para gerar uma análise.</div><div id="ai-loading" class="hidden my-4"><div class="spinner"></div></div><button id="generate-ai-insights" class="mt-4 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full sm:w-auto self-start"><i class="fas fa-wand-magic-sparkles mr-2"></i>Gerar Análise</button></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Evolução Temporal</h2><select id="timeline-chart-type" class="chart-type-selector"><option value="line">Linha</option><option value="bar">Barra</option></select></div><div class="chart-container"><canvas id="timeline-chart"></canvas></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Performance por Cidade</h2><select id="city-chart-type" class="chart-type-selector"><option value="bar">Barra</option><option value="line">Linha</option><option value="pie">Pizza</option></select></div><div class="chart-container"><canvas id="city-chart"></canvas></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Investimento por Tipo de Campanha</h2><select id="campaign-type-chart-type" class="chart-type-selector"><option value="bar">Barra</option><option value="pie">Pizza</option><option value="doughnut">Rosca</option></select></div><div class="chart-container"><canvas id="campaign-type-chart"></canvas></div></div>
                    <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Distribuição por Status</h2><select id="status-chart-type" class="chart-type-selector"><option value="doughnut">Rosca</option><option value="pie">Pizza</option><option value="bar">Barra</option></select></div><div class="chart-container"><canvas id="status-chart"></canvas></div></div>
                </div>
                <div class="card"><div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><h2 class="font-bold text-lg">Ranking de Campanhas</h2><input type="search" id="campaign-search" placeholder="Pesquisar campanha..." class="search-input md:w-1/3"></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-2 sortable-header" data-sort="name">Campanha <i class="fas fa-sort"></i></th><th class="p-2 sortable-header" data-sort="spend">Gasto <i class="fas fa-sort"></i></th><th class="p-2 sortable-header" data-sort="leads">Leads <i class="fas fa-sort"></i></th><th class="p-2 sortable-header" data-sort="cpl">CPL <i class="fas fa-sort"></i></th></tr></thead><tbody id="campaign-ranking-body"></tbody></table></div><div id="pagination-controls" class="mt-4 flex justify-center items-center gap-2"></div></div>
            </div>
        </div>
    </div>

<script>
    const { jsPDF } = window.jspdf;
    Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#334155'; Chart.defaults.plugins.legend.position = 'bottom'; Chart.defaults.maintainAspectRatio = false;
    
    let originalData = [], filteredData = [], charts = {};
    const GEMINI_API_KEY = 'AIzaSyA0LecQ2UW0nZvLTlnp-Utp4NHxVeIfvX8';
    const chartColors = ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6'];
    const elements = {
        fileUpload: document.getElementById('file-upload'), dropZone: document.getElementById('file-drop-zone'),
        fileName: document.getElementById('file-name'), uploadSection: document.getElementById('upload-section'),
        dashboardContent: document.getElementById('dashboard-content'), clearFiltersBtn: document.getElementById('clear-filters-btn'),
        dropZoneText: document.getElementById('drop-zone-text'), downloadPdfBtn: document.getElementById('download-pdf-btn'),
        aiBtn: document.getElementById('generate-ai-insights'), aiContent: document.getElementById('ai-insights-content'),
        aiLoading: document.getElementById('ai-loading'), loadingOverlay: document.getElementById('loading-overlay'),
        campaignSearch: document.getElementById('campaign-search'), paginationControls: document.getElementById('pagination-controls')
    };
    let tableState = { currentPage: 1, rowsPerPage: 5, searchTerm: '', sortColumn: 'spend', sortDirection: 'desc' };

    const formatCurrency = (v) => `R$ ${v.toFixed(2).replace('.', ',')}`;
    const formatNumber = (v) => new Intl.NumberFormat('pt-BR').format(v);
    const parseValue = (v) => { if (typeof v !== 'string' || v === '') return 0; const c = v.replace('R$', '').trim().replace(/\./g, '').replace(',', '.'); return isNaN(parseFloat(c)) ? 0 : parseFloat(c); };
    
    function parseDate(dateStr) {
        if (!dateStr) return null;
        // Handles YYYY-MM-DD, MM/DD/YYYY, DD/MM/YYYY
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // Assuming format DD/MM/YYYY as common in Brazil
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                if (day <= 31 && month <= 12 && year > 1900) {
                    return new Date(Date.UTC(year, month - 1, day));
                }
            }
        }
        // Fallback for ISO format YYYY-MM-DD and others
        const d = new Date(dateStr);
        // Check if the date is valid
        if (!isNaN(d.getTime())) {
            // Adjust for timezone issues with ISO strings
            return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
        }
        return null;
    }

    elements.fileUpload.addEventListener('change', (e) => handleFile(e.target.files[0]));
    elements.dropZone.addEventListener('click', () => elements.fileUpload.click());
    elements.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); elements.dropZone.classList.add('dragover'); });
    elements.dropZone.addEventListener('dragleave', () => elements.dropZone.classList.remove('dragover'));
    elements.dropZone.addEventListener('drop', (e) => { e.preventDefault(); elements.dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });

    function handleFile(file) {
        if (!file || file.type !== 'text/csv') return console.error('Tipo de arquivo inválido.');
        elements.fileName.textContent = file.name; elements.dropZoneText.textContent = 'Processando...';
        Papa.parse(file, { header: true, skipEmptyLines: true, complete: (r) => { processData(r.data); elements.uploadSection.classList.add('hidden'); elements.dashboardContent.classList.remove('hidden'); elements.downloadPdfBtn.classList.remove('hidden'); }, error: (err) => { console.error('Erro no PapaParse:', err); elements.dropZoneText.textContent = 'Erro ao ler o arquivo.'; }});
    }

    function processData(data) {
        originalData = data.map(row => ({
            campaignName: row['Campaign Name'] || 'N/A', date: parseDate(row['Date']), spend: parseValue(row['Spend (Cost, Amount Spent)']),
            status: row['Campaign Status'] || 'N/A', leads: parseInt(row['Action Leads'], 10) || 0, clicks: parseInt(row['Clicks'], 10) || parseValue(row['Clicks']),
            impressions: parseInt(row['Impressions'], 10) || 0, cidade: row['Cidade'] || 'N/A', tipoCampanha: row['Tipo de Campanha'] || 'N/A',
        })).filter(row => row.date instanceof Date && !isNaN(row.date.getTime()));
        
        if (originalData.length > 0) {
            const dates = originalData.map(d => d.date);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            const toYYYYMMDD = (date) => date.toISOString().split('T')[0];
            document.getElementById('filter-start-date').value = toYYYYMMDD(minDate);
            document.getElementById('filter-end-date').value = toYYYYMMDD(maxDate);
        }

        populateFilters(); addListeners(); applyFilters();
    }
    
    function populateFilters() {
        const unique = (key) => [...new Set(originalData.map(item => item[key]))].sort();
        const populateSelect = (id, values) => { const select = document.getElementById(id); select.innerHTML = `<option value="">${select.firstElementChild.textContent}</option>`; values.forEach(v => v && select.add(new Option(v, v))); };
        populateSelect('filter-cidade', unique('cidade')); populateSelect('filter-tipo', unique('tipoCampanha')); populateSelect('filter-status', unique('status'));
    }

    function addListeners() {
        document.querySelectorAll('#filters-section select, #filters-section input[type="date"]').forEach(el => el.addEventListener('change', applyFilters));
        elements.clearFiltersBtn.addEventListener('click', () => { document.querySelectorAll('#filters-section select').forEach(el => el.selectedIndex = 0); document.querySelectorAll('#filters-section input[type="date"]').forEach(el => el.value = ''); applyFilters(); });
        document.querySelectorAll('.chart-type-selector').forEach(sel => sel.addEventListener('change', applyFilters));
        elements.downloadPdfBtn.addEventListener('click', downloadPDF);
        elements.aiBtn.addEventListener('click', generateInsights);
        elements.campaignSearch.addEventListener('input', (e) => { tableState.searchTerm = e.target.value; tableState.currentPage = 1; updateTables(); });
        document.querySelectorAll('.sortable-header').forEach(header => header.addEventListener('click', (e) => {
            const newSortColumn = e.currentTarget.dataset.sort;
            if (tableState.sortColumn === newSortColumn) { tableState.sortDirection = tableState.sortDirection === 'asc' ? 'desc' : 'asc'; } else { tableState.sortColumn = newSortColumn; tableState.sortDirection = 'desc'; }
            updateTables();
        }));
    }

    function applyFilters() {
        const f = { cidade: document.getElementById('filter-cidade').value, tipo: document.getElementById('filter-tipo').value, status: document.getElementById('filter-status').value, start: document.getElementById('filter-start-date').valueAsDate, end: document.getElementById('filter-end-date').valueAsDate };
        if (f.start) f.start.setUTCHours(0, 0, 0, 0);
        if (f.end) f.end.setUTCHours(23, 59, 59, 999);
        filteredData = originalData.filter(row => (!f.cidade || row.cidade === f.cidade) && (!f.tipo || row.tipoCampanha === f.tipo) && (!f.status || row.status === f.status) && (!f.start || row.date >= f.start) && (!f.end || row.date <= f.end));
        updateDashboard();
    }
    
    function updateDashboard() { updateCards(); updateAllCharts(); updateTables(); }

    function updateCards() {
        const totalSpend = filteredData.reduce((s, r) => s + r.spend, 0), totalLeads = filteredData.reduce((s, r) => s + r.leads, 0),
        totalImpressions = filteredData.reduce((s, r) => s + r.impressions, 0), totalClicks = filteredData.reduce((s, r) => s + r.clicks, 0);
        const ctr = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0, cpl = totalLeads > 0 ? totalSpend / totalLeads : 0;
        document.getElementById('total-investido').textContent = formatCurrency(totalSpend); document.getElementById('total-leads').textContent = formatNumber(totalLeads);
        document.getElementById('total-impressoes').textContent = formatNumber(totalImpressions); document.getElementById('total-cliques').textContent = formatNumber(totalClicks);
        document.getElementById('ctr').textContent = `${ctr.toFixed(2)}%`; document.getElementById('cpl').textContent = formatCurrency(cpl);
    }

    function updateTables() {
        const campaignData = filteredData.reduce((acc, row) => { acc[row.campaignName] = acc[row.campaignName] || { spend: 0, leads: 0 }; acc[row.campaignName].spend += row.spend; acc[row.campaignName].leads += row.leads; return acc; }, {});
        let processedData = Object.entries(campaignData).map(([name, d]) => ({ name, ...d, cpl: d.leads > 0 ? d.spend / d.leads : 0 }));
        
        if (tableState.searchTerm) { processedData = processedData.filter(c => c.name.toLowerCase().includes(tableState.searchTerm.toLowerCase())); }
        
        processedData.sort((a, b) => {
            const valA = a[tableState.sortColumn]; const valB = b[tableState.sortColumn];
            const compare = typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
            return tableState.sortDirection === 'asc' ? compare : -compare;
        });

        const body = document.getElementById('campaign-ranking-body'); body.innerHTML = '';
        const startIndex = (tableState.currentPage - 1) * tableState.rowsPerPage;
        const paginatedData = processedData.slice(startIndex, startIndex + tableState.rowsPerPage);
        paginatedData.forEach(c => {
            const row = body.insertRow(); row.className = 'border-b border-slate-800 hover:bg-slate-700/50';
            row.innerHTML = `<td class="p-2 font-medium">${c.name}</td><td class="p-2">${formatCurrency(c.spend)}</td><td class="p-2">${formatNumber(c.leads)}</td><td class="p-2">${formatCurrency(c.cpl)}</td>`;
        });
        renderPagination(processedData.length);
    }
    
    function renderPagination(totalRows) {
        const pageCount = Math.ceil(totalRows / tableState.rowsPerPage);
        elements.paginationControls.innerHTML = '';
        for (let i = 1; i <= pageCount; i++) {
            const btn = document.createElement('button'); btn.textContent = i; btn.className = 'pagination-btn';
            if (i === tableState.currentPage) btn.classList.add('active');
            btn.addEventListener('click', () => { tableState.currentPage = i; updateTables(); });
            elements.paginationControls.appendChild(btn);
        }
    }

    function drawOrUpdateChart(id, type, data, options = {}) { if (charts[id]) charts[id].destroy(); charts[id] = new Chart(document.getElementById(id), { type, data, options }); }

    function updateAllCharts() {
        const groupBy = (key) => filteredData.reduce((acc, item) => { const group = item[key] || 'N/A'; if (!acc[group]) acc[group] = { spend: 0, leads: 0 }; acc[group].spend += item.spend; acc[group].leads += item.leads; return acc; }, {});
        const timeData = filteredData.reduce((acc, item) => { const date = item.date.toISOString().split('T')[0]; if (!acc[date]) acc[date] = { spend: 0, leads: 0 }; acc[date].spend += item.spend; acc[date].leads += item.leads; return acc; }, {});
        const sortedDates = Object.keys(timeData).sort();
        drawOrUpdateChart('timeline-chart', document.getElementById('timeline-chart-type').value, { labels: sortedDates, datasets: [ { label: 'Investimento', data: sortedDates.map(d => timeData[d].spend), backgroundColor: chartColors[0], yAxisID: 'y' }, { label: 'Leads', data: sortedDates.map(d => timeData[d].leads), backgroundColor: chartColors[1], yAxisID: 'y1' } ]}, { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { position: 'left' }, y1: { position: 'right', grid: { drawOnChartArea: false } } } });
        const cityData = groupBy('cidade'), cityLabels = Object.keys(cityData); drawOrUpdateChart('city-chart', document.getElementById('city-chart-type').value, { labels: cityLabels, datasets: [ { label: 'Investimento', data: cityLabels.map(c => cityData[c].spend), backgroundColor: chartColors[0] }, { label: 'Leads', data: cityLabels.map(c => cityData[c].leads), backgroundColor: chartColors[1] } ]});
        const typeData = groupBy('tipoCampanha'), typeLabels = Object.keys(typeData); drawOrUpdateChart('campaign-type-chart', document.getElementById('campaign-type-chart-type').value, { labels: typeLabels, datasets: [{ label: 'Investimento', data: typeLabels.map(t => typeData[t].spend), backgroundColor: chartColors }]});
        const statusData = groupBy('status'), statusLabels = Object.keys(statusData); drawOrUpdateChart('status-chart', document.getElementById('status-chart-type').value, { labels: statusLabels, datasets: [{ label: 'Investimento', data: statusLabels.map(s => statusData[s].spend), backgroundColor: chartColors }]});
    }

    async function downloadPDF() {
        elements.loadingOverlay.classList.remove('hidden');
        const content = document.getElementById('printable-content'); const canvas = await html2canvas(content, { backgroundColor: '#0f172a', scale: 2 });
        const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight(); const imgProps = pdf.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width; let heightLeft = imgHeight, position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight); heightLeft -= pdfHeight;
        while (heightLeft > 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight); heightLeft -= pdfHeight; }
        pdf.save('dashboard-analytics.pdf'); elements.loadingOverlay.classList.add('hidden');
    }

    async function generateInsights() {
        elements.aiBtn.disabled = true;
        elements.aiContent.classList.add('hidden');
        elements.aiLoading.classList.remove('hidden');

        if (filteredData.length === 0) {
            elements.aiContent.textContent = 'Não há dados suficientes para gerar uma análise. Por favor, ajuste os filtros ou carregue um arquivo com dados.';
            elements.aiBtn.disabled = false;
            elements.aiContent.classList.remove('hidden');
            elements.aiLoading.classList.add('hidden');
            return;
        }

        const totalSpend = filteredData.reduce((s, r) => s + r.spend, 0), totalLeads = filteredData.reduce((s, r) => s + r.leads, 0);
        const campaignSpend = filteredData.reduce((acc, row) => {
            if (row.campaignName !== 'N/A') {
                acc[row.campaignName] = (acc[row.campaignName] || 0) + row.spend;
            }
            return acc;
        }, {});
        const topCampaign = Object.keys(campaignSpend).length > 0 ? Object.entries(campaignSpend).sort(([, a], [, b]) => b - a)[0] : null;

        const prompt = `Aja como um analista de marketing digital sênior. Analise os seguintes dados de campanhas e forneça insights acionáveis em português. Dados: - Investimento Total: ${formatCurrency(totalSpend)} - Total de Leads: ${formatNumber(totalLeads)} - Custo por Lead (CPL) Médio: ${formatCurrency(totalLeads > 0 ? totalSpend / totalLeads : 0)} - Campanha com maior investimento: ${topCampaign ? topCampaign[0] : 'N/A'} (${formatCurrency(topCampaign ? topCampaign[1] : 0)}) - Período dos dados: ${document.getElementById('filter-start-date').value || 'Início'} a ${document.getElementById('filter-end-date').value || 'Fim'}. Forneça uma análise concisa em 3 parágrafos: 1. Um resumo geral da performance. 2. Destaque um ponto positivo e um ponto de atenção ou risco. 3. Dê uma recomendação clara e objetiva para otimizar os resultados futuros.`;
        
        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
            if (!response.ok) { const errorBody = await response.text(); throw new Error(`API Error ${response.status}: ${errorBody}`); }
            const result = await response.json();
            
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error('Resposta da API inválida ou sem texto.');

            elements.aiContent.textContent = text;
        } catch (error) { 
            elements.aiContent.textContent = 'Não foi possível gerar a análise. Verifique a chave de API, a conexão com a internet ou se há restrições de uso na sua conta Google AI.'; 
            console.error('Gemini API Error:', error);
        } finally { 
            elements.aiBtn.disabled = false; 
            elements.aiContent.classList.remove('hidden'); 
            elements.aiLoading.classList.add('hidden'); 
        }
    }
</script>
</body>
</html>

